shadow$provide.module$node_modules$$supabase$auth_js$dist$main$lib$locks = function(require, module, exports) {
  Object.defineProperty(exports, "__esModule", {value:!0});
  exports.ProcessLockAcquireTimeoutError = exports.NavigatorLockAcquireTimeoutError = exports.LockAcquireTimeoutError = exports.internals = void 0;
  exports.navigatorLock = async function(name, acquireTimeout, fn) {
    exports.internals.debug && console.log("@supabase/gotrue-js: navigatorLock: acquire lock", name, acquireTimeout);
    const abortController = new globalThis.AbortController();
    acquireTimeout > 0 && setTimeout(() => {
      abortController.abort();
      exports.internals.debug && console.log("@supabase/gotrue-js: navigatorLock acquire timed out", name);
    }, acquireTimeout);
    await Promise.resolve();
    try {
      return await globalThis.navigator.locks.request(name, acquireTimeout === 0 ? {mode:"exclusive", ifAvailable:!0} : {mode:"exclusive", signal:abortController.signal}, async lock => {
        if (lock) {
          exports.internals.debug && console.log("@supabase/gotrue-js: navigatorLock: acquired", name, lock.name);
          try {
            return await fn();
          } finally {
            exports.internals.debug && console.log("@supabase/gotrue-js: navigatorLock: released", name, lock.name);
          }
        } else {
          if (acquireTimeout === 0) {
            throw exports.internals.debug && console.log("@supabase/gotrue-js: navigatorLock: not immediately available", name), new NavigatorLockAcquireTimeoutError(`Acquiring an exclusive Navigator LockManager lock "${name}" immediately failed`);
          }
          if (exports.internals.debug) {
            try {
              const result = await globalThis.navigator.locks.query();
              console.log("@supabase/gotrue-js: Navigator LockManager state", JSON.stringify(result, null, "  "));
            } catch (e) {
              console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state", e);
            }
          }
          console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request");
          return await fn();
        }
      });
    } catch (e) {
      if ((e === null || e === void 0 ? void 0 : e.name) === "AbortError") {
        throw new NavigatorLockAcquireTimeoutError(`Acquiring an exclusive Navigator LockManager lock "${name}" timed out waiting ${acquireTimeout}ms`);
      }
      throw e;
    }
  };
  exports.processLock = async function(name, acquireTimeout, fn) {
    var _a;
    const previousOperation = (_a = PROCESS_LOCKS[name]) !== null && _a !== void 0 ? _a : Promise.resolve(), previousOperationHandled = (async() => {
      try {
        return await previousOperation, null;
      } catch (e) {
        return null;
      }
    })(), currentOperation = (async() => {
      let timeoutId = null;
      try {
        const timeoutPromise = acquireTimeout >= 0 ? new Promise((_, reject) => {
          timeoutId = setTimeout(() => {
            console.warn(`@supabase/gotrue-js: Lock "${name}" acquisition timed out after ${acquireTimeout}ms. ` + "This may be caused by another operation holding the lock. Consider increasing lockAcquireTimeout or checking for stuck operations.");
            reject(new ProcessLockAcquireTimeoutError(`Acquiring process lock with name "${name}" timed out`));
          }, acquireTimeout);
        }) : null;
        await Promise.race([previousOperationHandled, timeoutPromise].filter(x => x));
        timeoutId !== null && clearTimeout(timeoutId);
      } catch (e) {
        if (timeoutId !== null && clearTimeout(timeoutId), e && e.isAcquireTimeout) {
          throw e;
        }
      }
      return await fn();
    })();
    PROCESS_LOCKS[name] = (async() => {
      try {
        return await currentOperation;
      } catch (e) {
        if (e && e.isAcquireTimeout) {
          try {
            await previousOperation;
          } catch (prevError) {
          }
          return null;
        }
        throw e;
      }
    })();
    return await currentOperation;
  };
  require = require("module$node_modules$$supabase$auth_js$dist$main$lib$helpers");
  exports.internals = {debug:!!(globalThis && (0,require.supportsLocalStorage)() && globalThis.localStorage && globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug") === "true")};
  class LockAcquireTimeoutError extends Error {
    constructor(message) {
      super(message);
      this.isAcquireTimeout = !0;
    }
  }
  exports.LockAcquireTimeoutError = LockAcquireTimeoutError;
  class NavigatorLockAcquireTimeoutError extends LockAcquireTimeoutError {
  }
  exports.NavigatorLockAcquireTimeoutError = NavigatorLockAcquireTimeoutError;
  class ProcessLockAcquireTimeoutError extends LockAcquireTimeoutError {
  }
  exports.ProcessLockAcquireTimeoutError = ProcessLockAcquireTimeoutError;
  const PROCESS_LOCKS = {};
};

//# sourceMappingURL=module$node_modules$$supabase$auth_js$dist$main$lib$locks.js.map
